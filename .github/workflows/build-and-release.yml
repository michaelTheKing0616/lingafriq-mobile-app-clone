name: Build and Release iOS & Android

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  increment-version:
    name: Increment Version Number
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.increment.outputs.version }}
      version_name: ${{ steps.increment.outputs.version_name }}
      build_number: ${{ steps.increment.outputs.build_number }}
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”¢ Increment build number
        id: increment
        run: |
          # Extract current version from pubspec.yaml
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          version_name=$(echo $current_version | cut -d'+' -f1)
          build_number=$(echo $current_version | cut -d'+' -f2)
          
          echo "ğŸ“¦ Current version: $current_version"
          echo "ğŸ“¦ Version name: $version_name"
          echo "ğŸ“¦ Current build number: $build_number"
          
          # Always increment build number (Play Console last used 90, so we need at least 91)
          if [ -z "$build_number" ] || [ "$build_number" -le 90 ]; then
            echo "âš ï¸ Build number $build_number is <= 90. Setting to 91."
            build_number=91
          else
            # Increment build number
            build_number=$((build_number + 1))
            echo "ğŸ“¦ Incrementing build number to: $build_number"
          fi
          
          new_version="${version_name}+${build_number}"
          
          # Update pubspec.yaml with the new version
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^version:.*/version: $new_version/" pubspec.yaml
          else
            sed -i "s/^version:.*/version: $new_version/" pubspec.yaml
          fi
          
          # Verify the update
          updated_version=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "âœ… Updated pubspec.yaml version to: $updated_version"
          
          if [ "$updated_version" != "$new_version" ]; then
            echo "âŒ ERROR: Version update failed! Expected $new_version but got $updated_version"
            exit 1
          fi
          
          echo "version=$new_version" >> $GITHUB_OUTPUT
          echo "version_name=$version_name" >> $GITHUB_OUTPUT
          echo "build_number=$build_number" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Final version: $new_version (build number: $build_number)"

      - name: ğŸ’¾ Commit version update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pubspec.yaml
          git commit -m "chore: auto-increment build number to ${{ steps.increment.outputs.version }}" || echo "No changes to commit"
          git push || echo "Push failed or no changes"

  build-android:
    name: Build Android App Bundle
    needs: increment-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ needs.increment-version.outputs.version }}
      version_name: ${{ needs.increment-version.outputs.version_name }}
      build_number: ${{ needs.increment-version.outputs.build_number }}

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'

      - name: âœ… Verify and enforce version
        run: |
          expected_version="${{ needs.increment-version.outputs.version }}"
          expected_build_number="${{ needs.increment-version.outputs.build_number }}"
          
          echo "ğŸ“¦ Expected version: $expected_version"
          echo "ğŸ“¦ Expected build number: $expected_build_number"
          
          # Read current version from pubspec.yaml
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          current_build_number=$(echo $current_version | cut -d'+' -f2)
          
          echo "ğŸ“¦ Current version in pubspec.yaml: $current_version"
          echo "ğŸ“¦ Current build number: $current_build_number"
          
          # If version doesn't match, update it
          if [ "$current_version" != "$expected_version" ]; then
            echo "âš ï¸ Version mismatch! Updating pubspec.yaml to $expected_version"
            if [[ "$OSTYPE" == "darwin"* ]]; then
              sed -i '' "s/^version:.*/version: $expected_version/" pubspec.yaml
            else
              sed -i "s/^version:.*/version: $expected_version/" pubspec.yaml
            fi
            
            # Verify update
            updated_version=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
            if [ "$updated_version" != "$expected_version" ]; then
              echo "âŒ ERROR: Failed to update version!"
              exit 1
            fi
            echo "âœ… Updated pubspec.yaml to $expected_version"
          else
            echo "âœ… Version already correct: $current_version"
          fi
          
          # Double-check the build number
          final_build_number=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ' | cut -d'+' -f2)
          if [ "$final_build_number" -lt 91 ]; then
            echo "âŒ ERROR: Build number $final_build_number is less than 91!"
            exit 1
          fi
          echo "âœ… Build number verified: $final_build_number"

      - name: ğŸ› ï¸ Configure Android SDK
        run: |
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/tools/bin" >> $GITHUB_PATH

      - name: ğŸ§© Install Android SDK components
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-35" "build-tools;35.0.0" "ndk;26.1.10909125"

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ğŸ”¢ Use incremented version
        run: |
          version="${{ needs.increment-version.outputs.version }}"
          echo "ğŸ“¦ Using version: $version"
          grep "version: $version" pubspec.yaml || echo "âš ï¸ Version mismatch in pubspec.yaml"

      - name: ğŸ”‘ Setup signing key
        run: |
          echo "Decoding keystore..."
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "Creating key.properties..."
          mkdir -p android
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=app/upload-keystore.jks" >> android/key.properties

      - name: ğŸ§± Clean build cache
        run: flutter clean

      - name: ğŸ—ï¸ Build AAB (Release)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          STABILITY_AI_KEY: ${{ secrets.STABILITY_AI_KEY }}
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          build_args="--release --split-debug-info=build/symbols"
          
          if [ -n "$GROQ_API_KEY" ]; then
            build_args="$build_args --dart-define=GROQ_API_KEY=$GROQ_API_KEY"
          else
            echo "âš ï¸ Warning: GROQ_API_KEY secret not set. Building without API key."
          fi
          
          if [ -n "$STABILITY_AI_KEY" ]; then
            build_args="$build_args --dart-define=STABILITY_AI_KEY=$STABILITY_AI_KEY"
          fi
          
          if [ -n "$HUGGINGFACE_TOKEN" ]; then
            build_args="$build_args --dart-define=HUGGINGFACE_TOKEN=$HUGGINGFACE_TOKEN"
          fi
          
          flutter build appbundle $build_args

      - name: Build Android APK
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          STABILITY_AI_KEY: ${{ secrets.STABILITY_AI_KEY }}
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          build_args="--release --split-debug-info=build/symbols"
          
          if [ -n "$GROQ_API_KEY" ]; then
            build_args="$build_args --dart-define=GROQ_API_KEY=$GROQ_API_KEY"
          else
            echo "âš ï¸ Warning: GROQ_API_KEY secret not set. Building without API key."
          fi
          
          if [ -n "$STABILITY_AI_KEY" ]; then
            build_args="$build_args --dart-define=STABILITY_AI_KEY=$STABILITY_AI_KEY"
          fi
          
          if [ -n "$HUGGINGFACE_TOKEN" ]; then
            build_args="$build_args --dart-define=HUGGINGFACE_TOKEN=$HUGGINGFACE_TOKEN"
          fi
          
          flutter build apk $build_args

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: ğŸšš Package AAB and mapping file
        run: |
          mkdir -p build/release
          version="${{ needs.increment-version.outputs.version }}"
          
          # Copy AAB
          cp build/app/outputs/bundle/release/app-release.aab "build/release/LingAfriq-${version}.aab"
          
          # Copy mapping.txt if it exists (generated by R8/ProGuard)
          if [ -f build/app/outputs/mapping/release/mapping.txt ]; then
            cp build/app/outputs/mapping/release/mapping.txt "build/release/mapping.txt"
            echo "âœ… Found mapping.txt file"
          else
            echo "âš ï¸ mapping.txt not found (check if minifyEnabled is true in build.gradle)"
          fi
          
          # Also copy symbols if they exist
          if [ -d build/symbols ]; then
            cp -r build/symbols "build/release/symbols" || true
          fi

      - name: ğŸ“¤ Upload AAB and mapping file
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ needs.increment-version.outputs.version }}
          path: |
            build/release/LingAfriq-${{ needs.increment-version.outputs.version }}.aab
            build/release/mapping.txt
          if-no-files-found: warn

  build-ios:
    name: Build iOS IPA
    needs: increment-version
    runs-on: macos-latest
    permissions:
      contents: write
    outputs:
      version: ${{ needs.increment-version.outputs.version }}
      version_name: ${{ needs.increment-version.outputs.version_name }}
      build_number: ${{ needs.increment-version.outputs.build_number }}

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ğŸ” Setup iOS Code Signing
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Decode certificate and provisioning profile from secrets
          if [ -n "$BUILD_CERTIFICATE_BASE64" ]; then
            echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
            echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > $PP_PATH
            
            # Create temporary keychain
            security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
            
            # Import certificate to keychain
            security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH
            
            # Apply provisioning profile
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
          else
            echo "âš ï¸ No iOS signing credentials found. Building without signing (will need manual signing for App Store)"
          fi

      - name: ğŸ”¢ Update iOS version info
        run: |
          version="${{ needs.increment-version.outputs.version }}"
          version_name="${{ needs.increment-version.outputs.version_name }}"
          build_number="${{ needs.increment-version.outputs.build_number }}"
          
          # Verify pubspec.yaml has the updated version
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          if [ "$current_version" != "$version" ]; then
            echo "âš ï¸ Version mismatch. Updating pubspec.yaml..."
            sed -i '' "s/^version: .*/version: $version/" pubspec.yaml
          fi
          
          # Update iOS project.pbxproj file
          # Update MARKETING_VERSION (version name)
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = $version_name/g" ios/Runner.xcodeproj/project.pbxproj
          # Update CURRENT_PROJECT_VERSION (build number)
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $build_number/g" ios/Runner.xcodeproj/project.pbxproj
          
          echo "ğŸ“¦ Updated iOS version: $version (build number: $build_number)"

      - name: ğŸ Install CocoaPods dependencies
        run: |
          cd ios
          # Remove Podfile.lock to force regeneration with correct Firebase versions
          rm -f Podfile.lock
          # Update CocoaPods repo and install dependencies
          pod repo update
          pod install --repo-update
          cd ..

      - name: ğŸ—ï¸ Build iOS Archive (Release)
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          STABILITY_AI_KEY: ${{ secrets.STABILITY_AI_KEY }}
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          build_args="--release --split-debug-info=build/symbols"
          
          if [ -n "$GROQ_API_KEY" ]; then
            build_args="$build_args --dart-define=GROQ_API_KEY=$GROQ_API_KEY"
          else
            echo "âš ï¸ Warning: GROQ_API_KEY secret not set. Building without API key."
          fi
          
          if [ -n "$STABILITY_AI_KEY" ]; then
            build_args="$build_args --dart-define=STABILITY_AI_KEY=$STABILITY_AI_KEY"
          fi
          
          if [ -n "$HUGGINGFACE_TOKEN" ]; then
            build_args="$build_args --dart-define=HUGGINGFACE_TOKEN=$HUGGINGFACE_TOKEN"
          fi
          
          if [ -n "$BUILD_CERTIFICATE_BASE64" ]; then
            # Build signed IPA
            echo "ğŸ” Building signed IPA..."
            flutter build ipa $build_args
          else
            # Build archive without signing (for manual signing later)
            echo "âš ï¸ No signing credentials found. Building archive without signing..."
            echo "ğŸ“ Note: You'll need to sign manually in Xcode for App Store submission"
            flutter build ios --no-codesign $build_args
          fi

      - name: ğŸšš Package iOS build with version
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
        run: |
          version="${{ needs.increment-version.outputs.version }}"
          mkdir -p build/release/ios
          
          echo "ğŸ” Searching for iOS build artifacts..."
          echo "Checking build/ios/ipa/..."
          ls -la build/ios/ipa/ 2>/dev/null || echo "No ipa directory"
          echo "Checking build/ios/archive/..."
          ls -la build/ios/archive/ 2>/dev/null || echo "No archive directory"
          
          if [ -n "$BUILD_CERTIFICATE_BASE64" ]; then
            # Signed IPA exists
            ipa_file=$(ls build/ios/ipa/*.ipa 2>/dev/null | head -n 1)
            if [ -n "$ipa_file" ] && [ -f "$ipa_file" ]; then
              cp "$ipa_file" "build/release/ios/LingAfriq-$version.ipa"
              echo "âœ… Signed IPA copied: build/release/ios/LingAfriq-$version.ipa"
            else
              echo "âš ï¸ IPA file not found in build/ios/ipa/, searching..."
              ipa_found=$(find build -name "*.ipa" -type f 2>/dev/null | head -n 1)
              if [ -n "$ipa_found" ] && [ -f "$ipa_found" ]; then
                cp "$ipa_found" "build/release/ios/LingAfriq-$version.ipa"
                echo "âœ… IPA found and copied: $ipa_found"
              else
                echo "âŒ No IPA file found anywhere"
              fi
            fi
          else
            # Archive without signing - create xcarchive zip
            if [ -d build/ios/archive/Runner.xcarchive ]; then
              cd build/ios/archive
              zip -r "../../../release/ios/LingAfriq-$version-unsigned.xcarchive.zip" Runner.xcarchive
              cd ../../..
              echo "âœ… Unsigned archive created: build/release/ios/LingAfriq-$version-unsigned.xcarchive.zip"
            elif [ -d build/ios/archive ]; then
              cd build/ios/archive
              zip -r "../../../release/ios/LingAfriq-$version-unsigned.zip" .
              cd ../../..
              echo "âœ… Archive packaged: build/release/ios/LingAfriq-$version-unsigned.zip"
            else
              echo "âš ï¸ Archive not found. Checking build directory..."
              find build -name "*.xcarchive" -type d || echo "No xcarchive found"
              find build -name "*.ipa" -type f || echo "No IPA found"
            fi
          fi
          
          echo "ğŸ“¦ Final iOS artifacts in build/release/ios/:"
          ls -lh build/release/ios/ || echo "No files found"

      - name: ğŸ“¤ Upload iOS build artifact
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ needs.increment-version.outputs.version }}
          path: build/release/ios/
          if-no-files-found: warn
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: always()

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download Android AAB and mapping file
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: android-aab-${{ needs.build-android.outputs.version }}
          path: build/release/android

      - name: ğŸ“¥ Download iOS IPA/Archive
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ios-build-${{ needs.build-ios.outputs.version }}
          path: build/release/ios

      - name: ğŸ·ï¸ Extract version info
        id: version
        run: |
          version="${{ needs.build-android.outputs.version }}"
          version_name="${{ needs.build-android.outputs.version_name }}"
          build_number="${{ needs.build-android.outputs.build_number }}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "version_name=$version_name" >> $GITHUB_OUTPUT
          echo "build_number=$build_number" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Check available artifacts
        id: check-artifacts
        run: |
          mkdir -p build/release/android build/release/ios
          echo "Checking for Android AAB..."
          if ls build/release/android/*.aab 2>/dev/null; then
            echo "android_exists=true" >> $GITHUB_OUTPUT
            ls -lh build/release/android/
          else
            echo "android_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Android AAB not found"
          fi
          
          echo "Checking for iOS artifacts..."
          if ls build/release/ios/*.ipa build/release/ios/*.zip 2>/dev/null; then
            echo "ios_exists=true" >> $GITHUB_OUTPUT
            ls -lh build/release/ios/
          else
            echo "ios_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ iOS artifacts not found"
          fi

      - name: ğŸ Create GitHub Release (Optional)
        continue-on-error: true
        if: steps.check-artifacts.outputs.android_exists == 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: "LingAfriq v${{ steps.version.outputs.version }}"
          tag_name: "v${{ steps.version.outputs.version }}"
          files: |
            build/release/android/*.aab
            build/release/android/mapping.txt
          generate_release_notes: true
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
